<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibonarium Real-Time (Proxy)</title>
<style>
body { margin:0; font-family:"Courier New", monospace; background:#0a0a0a; color:#9fe7ff; display:flex; flex-direction:column; align-items:center; padding:20px; }
h1 { text-align:center; margin-bottom:20px; }
.heatmap { display:grid; grid-template-columns:repeat(2, 300px); gap:15px; width:100%; max-width:650px; }
.card { padding:15px; border-radius:10px; text-align:center; color:#000; font-weight:bold; font-size:14px; transition:0.5s; }
.value { font-size:18px; margin-top:5px; }
#systemStatus { margin-top:20px; font-size:20px; font-weight:bold; color:#fff; }
</style>
</head>
<body>
<h1>Ibonarium Real-Time - –ï–∫–æ–ª–æ–≥—ñ—è</h1>
<div class="heatmap" id="heatmap"></div>
<div id="systemStatus">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>

<script>
// –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –ø—Ä–æ–∫—Å—ñ
const proxy = "https://api.allorigins.win/get?url=";

// –ü–æ–∫–∞–∑–Ω–∏–∫–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä—ñ–∞–ª—Ç–∞–π–º—É
const indicators = [
  {id:'pm25', label:'PM2.5', api:'https://api.openaq.org/v2/latest?parameter=pm25&limit=100', value:0, thresholds:[35,55]},
  {id:'pm10', label:'PM10', api:'https://api.openaq.org/v2/latest?parameter=pm10&limit=100', value:0, thresholds:[50,100]},
  {id:'no2', label:'NO2', api:'https://api.openaq.org/v2/latest?parameter=no2&limit=100', value:0, thresholds:[40,80]},
  {id:'o3', label:'O3', api:'https://api.openaq.org/v2/latest?parameter=o3&limit=100', value:0, thresholds:[60,120]},
  {id:'quakes', label:'–ó–µ–º–ª–µ—Ç—Ä—É—Å–∏ >M4 (–∑–∞ –≥–æ–¥–∏–Ω—É)', api:'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.0_hour.geojson', value:0, thresholds:[2,5]}
];

// –°—Ç–≤–æ—Ä—é—î–º–æ –∫–∞—Ä—Ç–æ—á–∫–∏
const heatmap = document.getElementById('heatmap');
function createCards() {
  indicators.forEach(ind=>{
    const div = document.createElement('div');
    div.className='card';
    div.id=ind.id;
    div.innerHTML=`${ind.label}<div class="value">Loading...</div>`;
    heatmap.appendChild(div);
  });
}

// –û–Ω–æ–≤–ª—é—î–º–æ –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–ª—å–æ—Ä–æ–º —Ç–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º
function updateCard(indicator) {
  const el = document.getElementById(indicator.id);
  const valEl = el.querySelector('.value');
  valEl.textContent = indicator.value;
  if(typeof indicator.value==='number'){
    if(indicator.value < indicator.thresholds[0]) el.style.backgroundColor='#4dd2ff'; // –∑–µ–ª–µ–Ω–∏–π
    else if(indicator.value < indicator.thresholds[1]) el.style.backgroundColor='#ffcc00'; // –∂–æ–≤—Ç–∏–π
    else el.style.backgroundColor='#ff4d4d'; // —á–µ—Ä–≤–æ–Ω–∏–π
  } else el.style.backgroundColor='#666'; // —è–∫—â–æ N/A
}

// –§–µ—Ç—á–∏–º–æ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—ñ
async function fetchData() {
  for(const ind of indicators){
    try{
      const url = proxy + encodeURIComponent(ind.api);
      const res = await fetch(url);
      const text = await res.json();
      let data;
      if(ind.api.includes('openaq')) data = JSON.parse(text.contents);
      else data = JSON.parse(text.contents);

      if(ind.api.includes('openaq')){
        const values = data.results.map(r=>r.measurements[0]?.value||0);
        ind.value = Math.round(values.reduce((a,b)=>a+b,0)/values.length);
      } else if(ind.id==='quakes'){
        ind.value = data.features.length;
      }
      updateCard(ind);
    } catch(e){ console.error('–ü–æ–º–∏–ª–∫–∞ fetch',ind.id,e); ind.value='N/A'; updateCard(ind);}
  }
  updateSystemStatus();
}

// –û—Ü—ñ–Ω–∫–∞ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —Å–∏—Å—Ç–µ–º–∏
function updateSystemStatus(){
  let numericValues = indicators.filter(i=>typeof i.value==='number').map(i=>i.value);
  if(numericValues.length===0) {document.getElementById('systemStatus').textContent='–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö ‚ùå'; return;}
  const avg = numericValues.reduce((a,b)=>a+b,0)/numericValues.length;
  const status = document.getElementById('systemStatus');
  if(avg<50) status.textContent='–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–∞ ‚úÖ';
  else if(avg<100) status.textContent='–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è ‚ö†Ô∏è';
  else status.textContent='–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Å—Ç–∞–Ω üö®';
}

createCards();
fetchData();
setInterval(fetchData,300000); // –∫–æ–∂–Ω—ñ 5 —Ö–≤
</script>
</body>
</html>
