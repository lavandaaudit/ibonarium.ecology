<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Екологічна карта забруднення повітря</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Heatmap -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
html, body, #map {
    height: 100%;
    margin: 0;
    font-family: sans-serif;
}
#panel {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: rgba(0,0,0,0.6);
    color: #fff;
    padding: 10px;
    border-radius: 6px;
    font-size: 14px;
}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
<strong>Забруднення повітря (PM2.5)</strong><br>
Оновлюється кожну хвилину
</div>

<script>
// ==================== Карта ====================
const map = L.map('map').setView([20, 0], 2);

// OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ==================== Heatmap ====================
let heatLayer = L.heatLayer([], {radius: 25, blur: 15, maxZoom: 6}).addTo(map);

// ==================== Дані OpenAQ ====================
async function fetchAirData() {
    try {
        const res = await fetch('https://api.openaq.org/v2/latest?parameter=pm25&limit=1000');
        const data = await res.json();

        const heatPoints = data.results
            .filter(d => d.measurements && d.measurements.length > 0)
            .map(d => {
                const value = d.measurements[0].value;
                const lat = d.coordinates.latitude;
                const lon = d.coordinates.longitude;
                // нормалізація значення PM2.5 для heatmap
                return [lat, lon, value];
            });

        heatLayer.setLatLngs(heatPoints);
    } catch(e) {
        console.error('Помилка завантаження даних OpenAQ', e);
    }
}

// ==================== Ріалтайм оновлення ====================
fetchAirData();
setInterval(fetchAirData, 60000); // кожну хвилину
</script>
</body>
</html>
